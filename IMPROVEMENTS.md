# üìã –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ TGBot (v2.0)

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|-----|--------|-----------|
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | 496 | 621 | +125 (+25%) |
| –ü–∞–∫–µ—Ç–æ–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | 23 | 13 | -10 (-43%) |
| –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ | –ß–∞—Å—Ç–∏—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è | ‚úÖ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | –ù–µ—Ç | –î–∞ | ‚úÖ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω–∞—è | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è | ‚úÖ |

## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ß—Ç–æ –±—ã–ª–æ:**
- –ú–æ–ª—á–∞–ª–∏–≤—ã–µ –æ—à–∏–±–∫–∏ (`except Exception: pass`)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ try-except –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –ë–î
- –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–ß—Ç–æ —Å—Ç–∞–ª–æ:**
- –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –§—É–Ω–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—Ö–∞/–Ω–µ—É–¥–∞—á–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ –æ–± –æ—à–∏–±–∫–∞—Ö

**–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `_safe_send_message()` - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `_safe_edit_message()` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- `_safe_delete_message()` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

### 2. üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å `logging` —Å —É—Ä–æ–≤–Ω—è–º–∏ INFO/WARNING/ERROR
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
  - –ü–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
  - –ó–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–æ–∫

**–ö–æ–º–∞–Ω–¥–∞ –≤ `main.py`:**
```python
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
```

### 3. üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_validate_zodiac_slug()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

**–û–±—Ä–µ–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:**
- –§—É–Ω–∫—Ü–∏—è `_truncate_message()` –æ–±—Ä–µ–∑–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è >4000 —Å–∏–º–≤–æ–ª–æ–≤
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–µ–∑–¥–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

### 4. üßπ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞

**–ò–∑–≤–ª–µ—á–µ–Ω—ã –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

| –§—É–Ω–∫—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°–æ–∫—Ä–∞—â–µ–Ω–æ –∫–æ–¥–∞ |
|---------|-----------|--------------|
| `_format_horoscope_message()` | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ | 3 –∫–æ–ø–∏–∏ ‚Üí 1 |
| `_update_subscriptions_list()` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ | 20 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è |
| `_parse_json_state()` | –ü–∞—Ä—Å–∏–Ω–≥ JSON –≥–æ—Ä–æ—Å–∫–æ–ø–∞ | 40 —Å—Ç—Ä–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é |
| `_parse_html_fallback()` | Fallback HTML –ø–∞—Ä—Å–∏–Ω–≥ | 15 —Å—Ç—Ä–æ–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é |

### 5. ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ë—ã–ª–æ:**
```python
# –í—Å—è –ª–æ–≥–∏–∫–∞ –≤ –æ–¥–Ω–æ–π 60-—Å—Ç—Ä–æ—á–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
# –°–º–µ—à–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å JSON –∏ HTML
```

**–°—Ç–∞–ª–æ:**
```python
def parse_horoscope(sign_slug):
    # –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ª–æ–≥–∏–∫–∞
    horoscope_text, rates = _parse_json_state(soup)
    if len(horoscope_text) < 200:
        horoscope_text = _parse_html_fallback(soup)
    return horoscope_text, rates
```

### 6. üì¶ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ:**
- `numpy` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `pandas` - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è  
- `anyio` - –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `httpx`
- `httpx` - telegram-bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç requests
- `httpcore` - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å httpx
- `typing_extensions` - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Python 3.10+

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 23 ‚Üí 13 –ø–∞–∫–µ—Ç–æ–≤ (-43%)

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### Bug #1: –î–≤–æ–π–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—Ç–ø–∏—Å–∫–µ –≤—ã–∑—ã–≤–∞–ª–∏—Å—å –æ—Ç–¥–µ–ª—å–Ω–æ `edit_text()` –∏ `edit_reply_markup()`
```python
# ‚ùå –ë—ã–ª–æ
await query.message.edit_text("\n".join(lines))
await query.message.edit_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard))
```

**–†–µ—à–µ–Ω–∏–µ:** –û–¥–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
```python
# ‚úÖ –¢–µ–ø–µ—Ä—å
await _safe_edit_message(query, "\n".join(lines), reply_markup)
```

### Bug #2: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ë–î
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –º–æ–≥–ª–∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫—Ä–∞—Ö—É
```python
# ‚ùå –ë—ã–ª–æ
conn.execute("SELECT ... FROM subscriptions")
```

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä–Ω—É—Ç—ã –≤ try-except
```python
# ‚úÖ –¢–µ–ø–µ—Ä—å
try:
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.execute(...)
    return [...]
except Exception as e:
    logging.error(f"–û—à–∏–±–∫–∞: {e}")
    return []
```

### Bug #3: –ú–æ–ª—á–∞–ª–∏–≤—ã–µ –æ—à–∏–±–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å
```python
# ‚ùå –ë—ã–ª–æ
try:
    await query.message.delete()
except Exception:
    pass  # ‚Üê –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞
```

**–†–µ—à–µ–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ –æ—à–∏–±–æ–∫
```python
# ‚úÖ –¢–µ–ø–µ—Ä—å
except Exception as e:
    logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: {e}")
```

### Bug #4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –≤ daily_horoscope
**–ü—Ä–æ–±–ª–µ–º–∞:** –ì–æ—Ä–æ—Å–∫–æ–ø—ã –≤ —Ä–∞—Å—Å—ã–ª–∫–µ –º–æ–≥–ª–∏ –±—ã—Ç—å >4000 —Å–∏–º–≤–æ–ª–æ–≤
```python
# ‚ùå –ë—ã–ª–æ - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞
message = f"{name}: –≥–æ—Ä–æ—Å–∫–æ–ø\n\n{horoscope_text}"
await context.bot.send_message(chat_id, message)
```

**–†–µ—à–µ–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è `_truncate_message()` –≤–µ–∑–¥–µ
```python
# ‚úÖ –¢–µ–ø–µ—Ä—å
message = _format_horoscope_message(name, horoscope_text, rates)
await _safe_send_message(context, chat_id, message)  # ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞
```

### Bug #5: –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `if sign_slug in zodiac_signs` –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
```python
# ‚ùå –ë—ã–ª–æ - –≤ 5 —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
if sign_slug not in zodiac_signs:
    ...
```

**–†–µ—à–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
```python
# ‚úÖ –¢–µ–ø–µ—Ä—å
def _validate_zodiac_slug(slug: str) -> bool:
    return slug in zodiac_signs

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–µ–∑–¥–µ
if not _validate_zodiac_slug(sign_slug):
    ...
```

## üìù –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏

```python
_validate_zodiac_slug(slug: str) -> bool
    ‚îÇ –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å slug –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞

_truncate_message(text: str, max_len: int = 4000) -> str
    ‚îÇ –û–±—Ä–µ–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram

_safe_send_message(context, chat_id, text, ...) -> bool
    ‚îÇ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫

_safe_edit_message(query, new_text, new_reply_markup) -> bool
    ‚îÇ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏

_safe_delete_message(context, message) -> bool
    ‚îÇ –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

_db_operation(func)
    ‚îÇ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è retry-–ª–æ–≥–∏–∫–∏ –ë–î –æ–ø–µ—Ä–∞—Ü–∏–π

_parse_json_state(soup: BeautifulSoup) -> (str, dict)
    ‚îÇ –ü–∞—Ä—Å–∏–Ω–≥ JSON –∏–∑ script —Ç–µ–≥–∞

_parse_html_fallback(soup: BeautifulSoup) -> str
    ‚îÇ Fallback –ø–∞—Ä—Å–∏–Ω–≥ HTML

_format_horoscope_message(name, text, rates, prefix) -> str
    ‚îÇ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º

_update_subscriptions_list(query, chat_id) -> None
    ‚îÇ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω—ã –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫–∂–µ, –Ω–æ —Ç–µ–ø–µ—Ä—å:
- ‚úÖ –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–µ–Ω (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- ‚úÖ –ü—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∏—Ç—å (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ)
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤)
- ‚úÖ –ß–∏—â–µ (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã**:
- API –±–æ—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫–∂–µ
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–π –∂–µ

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–¢–µ–ø–µ—Ä—å –≤—ã –≥–æ—Ç–æ–≤—ã –∫:
- –î–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (–∑–Ω–∞–µ—Ç, –≥–¥–µ –∏ –∫–∞–∫)
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é (—Ö–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É (–ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é (–º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

---

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 15.02.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production

